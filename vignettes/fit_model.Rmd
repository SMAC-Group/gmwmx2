---
title: "Estimate a model, extract estimated parameters and plot estimated model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimate a model, extract estimated parameters and plot estimated model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---






```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 8, # Set default plot width (adjust as needed)
  fig.height = 6, # Set default plot height (adjust as needed)
  fig.align = "center" # Center align all plots
)
```


The `gmwmx2` `R` package allows to estimate linear model with correlated residuals in presence of missing data.

More precisely, we assume the following model:
\begin{equation}
    \boldsymbol{Y} = \boldsymbol{X} \boldsymbol{\beta} + \boldsymbol{\varepsilon}, \quad \boldsymbol{\varepsilon} \sim \mathcal{F}\left\{\boldsymbol{\Sigma}\left(\boldsymbol{\gamma}\right)\right\},
\end{equation}

where $\boldsymbol{X} \in \mathbb{R}^{n \times p}$ is a design matrix of observed predictors, $\boldsymbol{\beta} \in \mathbb{R}^p$ is the regression parameter vector and $\boldsymbol{\varepsilon} = \{\varepsilon_{i}\}_{i=1,\ldots,n}$ is a zero-mean process following an unspecified joint distribution $\mathcal{F}$ with positive-definite covariance function $\boldsymbol{\Sigma}(\boldsymbol{\gamma}) \in \mathbb{R}^{n\times n}$ characterizing the second-order dependence structure of the process and parameterized by the vector $\boldsymbol{\gamma} \in \boldsymbol{\Gamma} \subset \mathbb{R}^q$. 

We then define the a random variable $\boldsymbol{Z} =\{Z_{i}\}_{i=1,\ldots,n}$ which describes the missing observation mechanism. More specifically, the vector $\boldsymbol{Z} \in \{0, 1\}^n$ is a binary-valued stationary process independent of $\boldsymbol{Y}$ with expectation $\mu(\boldsymbol{\vartheta}) = \mathbb{E}[Z_i] \in [0, \, 1)$, $\forall \, i$, and covariance matrix $\boldsymbol{\Lambda}(\boldsymbol{\vartheta}) = \mathbb{V}[\boldsymbol{Z}] \in \mathbb{R}^{n\times n}$ whose structure is assumed known up to the parameter vector $\boldsymbol{\vartheta} \in \boldsymbol{\Upsilon} \subset \mathbb{R}^k$


We then assume that we only observe the stochastic process $\tilde{\boldsymbol{Y}} = \boldsymbol{Z} \odot \boldsymbol{Y}$, where $\odot$ denotes the Hadamard product. Hence, $\tilde{\boldsymbol{Y}} \in \mathbb{R}^n = \boldsymbol{Y} \odot \boldsymbol{Z}$ represents the observed process vector with null elements in the positions where observations are missing. 

Using $\otimes$ to denote the Kronecker product, we then define $\tilde{\boldsymbol{X}} = \boldsymbol{Z} \otimes \boldsymbol{1}^T \odot \boldsymbol{X} \in \mathbb{R}^{n \times p}$ as the design matrix $\boldsymbol{X}$ with zero-valued vectors for the rows where observations are missing in $\boldsymbol{Y}$ (where $\boldsymbol{1}$ represents a vector of ones of dimension $p$).

We estimate the parameters $\boldsymbol{\beta}$ with the least square estimator:

\begin{equation}
    \hat{\boldsymbol{\beta}} = \left(\tilde{\boldsymbol{X}}^T \tilde{\boldsymbol{X}}\right)^{-1} \tilde{\boldsymbol{X}}^T \tilde{\boldsymbol{Y}}.
\end{equation}

We compute the estimated residuals as $\hat{\boldsymbol{\varepsilon}} = {\tilde{\boldsymbol{Y}}} - \tilde{{\boldsymbol{X}}} \hat{\boldsymbol{\beta}}$.

We then estimate with the Maximum Likelihood Estimator the parameters $\boldsymbol{\vartheta}$ of the missingness process $\boldsymbol{Z}$ assuming that $\boldsymbol{Z}$ is generated from a Markov model with the following transition probabilities:

\begin{equation}
    \label{eq:markov_model_def}
    \begin{aligned}
& P\left( Z_2=1 \mid Z_1=1\right)=1 - p_1 \\
& P\left(Z_2=1 \mid Z_1=0\right) = p_2 \\
& P\left(Z_2=0 \mid Z_1=1\right)=p_1 \\
& P\left(Z_2=0 \mid Z_1=0\right)=1-p_2.
\end{aligned}
\end{equation}

We then estimate the parameters $\boldsymbol{\gamma}$ using a Generalized method of Wavelet Moments approach ([Guerrier, S., Skaloud, J., Stebler, Y., Victoria-Feser, M.-P., 2013](https://www.tandfonline.com/doi/full/10.1080/01621459.2013.799920)) and using the fact that the variance-covariance matrix of $\hat{\boldsymbol{\varepsilon}}$ is given by:


$$\boldsymbol{\Sigma}_{\hat{\boldsymbol{\varepsilon}}}(\boldsymbol{\gamma}) = [\boldsymbol{\Lambda}(\hat{\boldsymbol{\vartheta}}) + \mu(\hat{\boldsymbol{\vartheta}})^2 \mathbf{1} \mathbf{1}^T ] \odot ( \boldsymbol{I} - \boldsymbol{P})\boldsymbol{\Sigma}(\boldsymbol{\gamma}) (\boldsymbol{I} - \boldsymbol{P})$$

where $\boldsymbol{P} = \boldsymbol{X}(\boldsymbol{X}^T\boldsymbol{X})^{-1}\boldsymbol{X}^T$ and $\boldsymbol{I}$ is the identity matrix of dimension $n\times n$.



While the GMWMX as described above and in more details in [Voirol, L., Xu, H., Zhang, Y., Insolia, L., Molinari, R. and Guerrier, S. (2024)](https://arxiv.org/abs/2409.05160), is a general method for estimating large linear model with complex dependence structure in presence of missing data, the `gmwmx2` `R` package is currently developed specifically to estimate tectonic velocities from position times series in graticule distance coordinates system (GD) provided by the Nevada geodetic Laboratory ([Blewitt, G., (2024)](https://link.springer.com/article/10.1007/s00190-023-01815-0)).

Hence, we construct the design matrix $\boldsymbol{X}$ such that $i$-th component of the vector $\mathbf{X} {{\boldsymbol{\beta}}}$ can be described as follows:

\begin{equation}
    \mathbb{E}[\mathbf{Y}_i] = \mathbf{X}_i^T {{\boldsymbol{\beta}}} = a+b\left(t_{i}\right)+\sum_{h=1}^{2}\left[c_{h} \sin \left(2 \pi f_{h} t_{i}\right)+d_{h} \cos \left(2 \pi f_{h} t_{i}\right)\right] + \sum_{k=1}^{n_{g}} g_{k} H\left(t_{i}-t_{k}\right) + \sum_{j = 1 }^{n_e}e_j (1- \exp(-(t_i-t_j)/T_j))H\left(t_{i}-T_j\right) ,
\end{equation}

where $a$ is the initial position at the reference epoch $t_0$, $b$ is the velocity parameter, $c_k$  and $d_k$ are the periodic motion parameters ($h = 1$ and $h = 2$ represent the annual and semi-annual seasonal terms, respectively). The offset terms models earthquakes, equipment changes or human intervention in which $g_k$ is the magnitude of the change at epochs $t_k$, $n_g$ is the total number of offsets, $H$ is the Heaviside step function and the last term allow to model post-seismic deformation where $n_e$ is the number of post seismic relaxation time specified, $t_j$ is the time when the relaxation $j$
starts in Modified Julian Date (MJD) and $T_j$ is the relaxation period in days for the post-seismic relaxation $j$. Note that the estimates of the parameters of the functional model are provided in unit/day.

More precisely, when loading data from a specific station using the function `gmwmx2::download_station_ngl()`, we extract from the Nevada Geodetic Laboratory the position time series in  GD coordinates, the time steps associated with a equipment or software change and the time steps associated with an earthquake near the station. All these objects are stored in a object of class `gnss_ts_ngl`.  

When applying the function `gmwmx2::gmwmx2()` to an object of class `gnss_ts_ngl`, we construct the design matrix $\boldsymbol{X}$ by considering an offset term for all equipment or software changes steps and all earthquakes indicated by the NGL. We also specify a post-seismic relaxation term for all earthquakes indicated by the NGL. If no relaxation time is specified in the argument `vec_earthquakes_relaxation_time`, we consider a default relaxation time of $365.25$ days. 

Regarding the stochastic model, the `gmwmx2` package currently only support one stochastic model for the error term which is a combination of White noise and Flicker/pink noise which is the most common stochastic model considered for GNSS position time series ([He, X., Bos, M.S., Fernandes, R.M.S., 2019](https://link.springer.com/article/10.1007/s00190-019-01244-y)).

Let us showcase how to estimate the tectonic velocity in for one specific component (North, East or Vertical) of one station.

Let us first load the `gmwmx2` package.
```{r}
library(gmwmx2)
```

# Download a station from Nevada Geodetic Laboratory
```{r}
station_data <- download_station_ngl("CHML")
```

# Plot Station
```{r}
# station_data$df_earthquakes
plot(station_data)

```


# Plot Northing component
```{r}
plot(station_data, component = "N")
```


# Estimate model on station data
```{r}
fit <- gmwmx2(station_data, n_seasonal = 2, component = "N")
```

# Extract estimated parameters
```{r}
summary(fit)
```

# Plot estimated model
```{r}
plot(fit)
```

